
							<h2>ABSTRACT</h2>
							<p>
							  Improper use of the Platform Invocation Services can render managed applications vulnerable to security flaws in other languages.
							</p>
							<h2>EXPLANATION</h2>
							<p>
							  Unsafe Native Invoke errors occur when a managed application uses P/Invoke to call native (unmanaged) code written in another programming language.<br>      <br><br><br><b>Example:</b> The following C# code defines a class named <code>Echo</code>. The class declares one native method (defined below), which uses C to echo commands entered on the console back to the user.<br><br><pre><br>class Echo<br>{<br>  [DllImport("mylib.dll")]<br>  internal static extern void RunEcho();<br>	<br>  static void main(String[] args)<br>  {<br>    RunEcho();<br>  }<br>}<br></pre><br><br>The following C code defines the native method implemented in the <code>Echo</code> class:<br><br><pre><br>#include &lt;stdio.h&gt;<br><br>void __stdcall RunEcho() <br>{<br>  char* buf = (char*) malloc(64 * sizeof(char));<br>  gets(buf);<br>  printf(buf);<br>}<br></pre><br><br>Because the Echo is implemented in managed code, it may appear that it is immune to memory issues like buffer overflow vulnerabilities. Although the managed environment does do a good job of making memory operations safe, this protection does not extend to vulnerabilities occurring in native code accessed using P/Invoke. Despite the memory protections offered in the managed runtime environment, the native code in this example is vulnerable to a buffer overflow because it makes use of <code>gets()</code>, which does not perform any bounds checking on its input.  As well, <code>buf</code> is allocated but not freed and therefore is a memory leak.<br><br>The vulnerability in the example above could easily be detected through a source code audit of the native method implementation. This may not be practical or possible depending on the availability of source code and the way the project is built, but in many cases it may suffice. However, the ability to share objects between the managed and native environments expands the potential risk to much more insidious cases where improper data handling in managed code may lead to unexpected vulnerabilities in native code or to unsafe operations in native code corrupting data structures in managed code.<br><br>Vulnerabilities in native code accessed through a managed application are typically exploited in the same manner as they are in applications written in the native language. The only challenge to such an attack is for the attacker to identify that the managed application uses native code to perform certain operations. This can be accomplished in a variety of ways, including identifying specific behaviors that are often implemented with native code or by exploiting a system information leak in the managed application that exposes its use of P/Invoke.
							</p>
							 								<h2>REFERENCES</h2>
																								   <p>[1] Standards Mapping - OWASP Top 10 2004 - (OWASP 2004) <em>A1 Unvalidated Input</em> <br></p>
																									   <p>[2] Standards Mapping - Security Technical Implementation Guide Version 3 - (STIG 3) <em>APP3510 CAT I</em> <br></p>
																									   <p>[3] Standards Mapping - Security Technical Implementation Guide Version 3.4 - (STIG 3.4) <em>APP3510 CAT I</em> <br></p>
																									   <p>[4] Standards Mapping - Common Weakness Enumeration - (CWE) <em>CWE ID 111</em> <br></p>
																									   <p>[5]  <em>How to: Call Native DLLs from Managed Code Using PInvoke</em> <br></p>
																									   <p>[6] Standards Mapping - Payment Card Industry Data Security Standard Version 1.2 - (PCI 1.2) <em>Requirement 6.3.1.1</em> <br></p>
																									   <p>[7] Standards Mapping - Payment Card Industry Data Security Standard Version 1.1 - (PCI 1.1) <em>Requirement 6.5.1</em> <br></p>
																									   <p>[8] Standards Mapping - FIPS200 - (FISMA) <em>SI</em> <br></p>
																									   <p>[9] Standards Mapping - NIST Special Publication 800-53 Revision 4 - (NIST SP 800-53 Rev.4) <em>SI-10 Information Input Validation</em> <br></p>
																														